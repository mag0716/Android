# Guide to app architecture

https://developer.android.com/jetpack/guide

## Mobile app user experiences

ユーザーは短時間に複数のアプリを操作することが多いためアプリはユーザー主導のさまざまな種類のワークフローやタスクに適用する必要がある。

また、モバイル端末はリソースに制約があるため、OSがアプリのプロセスを停止し、新しいプロセスのためのスペースを確保する可能性がある。

このような環境ではアプリのコンポーネントが個別に起動されたりじゅんちょが違ったりする可能性があり、OSやユーザーがいつでもそれらを破棄することができる。このようなイベントはコントロールできないので、アプリはデータや状態をコンポーネントやメモリに保存したり、コンポーネント同士を依存させるべきではない。

## Common architectural principles

アプリのデータや状態の保存にコンポーネントを使うべきではないとしたら代わりにどのように設計するべきなのか？

Androidアプリは規模が大きくなると、拡張性、堅牢性、テスト容易性を考慮したアーキテクチャが重要になる。

アーキテクチャはアプリの各部分の境界と各部分の責務を定義する。上記のニーズを満たすにはいくつかの原則に従って設計する必要がある。

### Separation of concerns

最も重要な原則は「関心事の分離」。ActivityやFragmentにすべてのコードを書くのはよくあるアンチパターン。これらのクラスにはUIとOSの操作を処理するロジックだけを含めるべきで、できるだけ無駄のないものにすることでライフサイクルに関連する多くの問題が回避され、テストが容易になる。

ActivityやFragmentはAndroid OSとアプリ間のつなぎであることに注意する。

### Drive UI from data models

もう一つの重要な原則はデータモデル、できれば永続的なモデルからUIを駆動させるべきだということ。データモデルはアプリのデータを表、UI要素などからは独立している。

永続的なモデルは以下の観点で理想的。

* Android OSがリソースを解放してもデータを失うことがない
* ネットワーク接続が利用できない場合でもアプリを動作することができる

データモデルに基づいてアーキテクチャを構築するとテストがしやすく、堅牢にすることができる。

## Recommended app architecture

Note: このページで紹介する推奨事項やベストプラクティスは幅広いアプリに適用することができ、アプリの拡張、品質と堅牢性の向上、テストの容易性を実現できる。ただし、あくまでガイドラインとして扱い必要に応じてアプリの要件に適合させる必要がある。

前節で述べた共通のアーキテクチャの原則を考慮するとアプリは少なくとも2つのレイヤーを持つ必要がある。

* アプリのデータを画面に表示するUI層
* アプリのビジネスロジックを含み、アプリのデータを公開するデータ層

ドメイン層を追加することでUI層とデータ層のインタラクションを簡素化し、再利用を可能にする。

Note: 図の矢印は依存関係を示し、ドメイン層はデータ層に依存することを表している。

### UI layer

UI層(プレゼンテーション層)の役割はアプリのデータを画面に表示すること。ユーザーの操作(ボタンのタップなど)や外部からの入力(ネットワークの応答など)によってデータが変更されるとUIは変更を反映するように更新させなければならない。

UI層は2つのものから構築されている。

* 画面上にデータを表示するUI要素(ViewsやJetpack Composeを利用し構築する)
* データを保持し、UIに後悔し、ロジックを処理するステートホルダ(ViewModelクラスなど)

UI層の詳細については https://developer.android.com/jetpack/guide/ui-layer

### Data Layer

データ層はビジネスロジッックを含む。ビジネスロジックはアプリがどのようにデータを作成、保存、変更するかを決定するルールで構築されている。

データ層はリポジトリで構成され、それぞれが0から多数のデータソースを格納することができる。アプリで扱うデータの種類毎にリポジトリを作成する必要がある。
例：MoviesRepository, PaymentsRepository

リポジトリクラスは以下のタスクを担当する。

* アプリの他の部分にデータを公開する
* データの変更を一元管理する
* 複数のデータソース間の競合を解決する
* アプリの他の部分からデータソースを抽象化する
* ビジネスロジックを含む
* 各データソースクラスはファイル、ネットワーク、ローカルなど1つのデータソースだけを扱う必要がある

データ層の詳細については https://developer.android.com/jetpack/guide/data-layer

### Domain Layer

ドメイン層はUI層とデータ層の間に位置するオプションの層。

ドメイン層は複雑なビジネスロジックや複数のViewModelで再利用されるシンプルなビジネスロジックをカプセル化する役割を担っている。全てのアプリでこの要件があるわけではないのでこの層はオプションとなっている。複雑なビジネスロジックを処理する場合や再利用性を高める場合など必要な場合にのみ利用する必要がある。

この層のクラスは一般的にユースケースやインタラクターと呼ばれる。各ユースケースは単一の機能に対しての責務を持つべき。例えば、ViewModelがタイムゾーンに依存して適切なメッセージを画面に表示する場合、`GetTimeZoneUseCase` を持たせることができる。

ドメイン層の詳細については https://developer.android.com/jetpack/guide/domain-layer

## Manage dependencies between components

アプリ内のクラスは正しく機能するために他のクラスに依存している。特定のクラスの依存関係を収集するためんに以下のデザインパターンのいずれかを使用することができる。

* DI：クラスが依存性を構築せずに定義するようにし、実行時に依存関係を提供する責任を負う
* Service locator：依存関係を取得するためのレジストリを提供する

これらのパターンは依存関係を管理するための明確なパターンを提供し、コードの重複や複雑性を排除するため、コードのスケーリングが可能になり、テスト用と本番用の実装の切り替えが容易になる。

Android アプリでは DIパターンに従い、Hiltライブラリの使用がお勧め。Hilt を利用することでコンパイル時保証が提供される。

## General best practices

以下の推奨事項は必須では無いがほとんどの場合、これらに従うことでコードベースがより堅牢でテストしやすくなり長期的に保守がしやすくなる。

### アプリのコンポーネントにデータを保存しない

Activity, Service, BroadcastReceiverなどアプリのエントリポイントをデータソースとして指定することは避け、他のコンポーネントと連携してそのエントリポイントに関係するデータを取得することだけを考える。

### Androidのクラスへの依存を減らす

アプリのコンポーネントは Context や Toast などの Android Framework SDK API に依存する唯一のクラスであるべき。他のクラスではそれらを抽象化することでテスト容易性を高め、アプリ内の結合を減らすことに役立つ。

### アプリ内のさまざまなモジュール間で責務を明確に定義する

例えば、ネットワークからデータをロードするコードを複数のクラスやパッケージに分散しないようにする。同様にデータのキャッシュやデータバインディングなど関連性のない複数の責任を同じクラスで定義しないようにする。

### 各モジュールの公開はできるだけ少なくする

例えば、あるモジュールから内部実装の詳細を公開するようなショートカットを作らないようにする。

### 他のアプリと区別するためにユニークなコアにフォーカスする

同じ定型的なコードを何度も書いて車輪の再発明をしない。代わりにアプリをユニークにすることにフォーカスし、Jetpackライブラリや推奨ライブラリを利用する。

### アプリの各パーツを分離してテスト可能にする方法を検討する

例えば、ネットワークからデータを取得するための明確なAPIがあれば、データをローカルデータベースに永続化するモジュールのテストが容易になる。もしこの2つのモジュールのロジックを一箇所に集めたりネットワークのコードをコードベース全体に分散させてしまうと効果的にテストすることが難しくなる。

### できるだけ多くの関連する最新のデータを持続させる

ユーザーはデバイスがオフラインモードであってもアプリの機能を楽しむことができる。ユーザーは高速通信を常に利用できるわけではないし、電波状況が悪くなる可能性もある。

## Samples

* [iosched](https://github.com/google/iosched)
* [Sunflower](https://github.com/android/sunflower)
* [Trackr](https://github.com/android/trackr)
* [Jetnews](https://github.com/android/compose-samples/tree/main/JetNews)
* [Architecture samples](https://github.com/android/architecture-samples)

Last updated 2021-12-14 UTC.
